{% extends "base.html" %}

{% block title %}My Profile - Agam Organics{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="container">
        <h1 class="page-title">My Account</h1>

        <div class="profile-layout">
            <!-- Sidebar Navigation -->
            <div class="profile-sidebar">
                <div class="profile-user-info">
                    <div class="user-avatar">{{ user.full_name[0] }}</div>
                    <h3>{{ user.full_name }}</h3>
                    <p>{{ user.email }}</p>
                </div>

                <nav class="profile-nav">
                    <a href="#personal-info" class="profile-nav-item active" onclick="showTab('personal-info')">
                        <i class="fas fa-user"></i> Personal Information
                    </a>
                    <a href="#addresses" class="profile-nav-item" onclick="showTab('addresses')">
                        <i class="fas fa-map-marker-alt"></i> My Addresses
                    </a>
                    <a href="#orders" class="profile-nav-item" onclick="showTab('orders')">
                        <i class="fas fa-box"></i> My Orders
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="profile-content">
                <!-- Personal Information -->
                <div id="personal-info" class="profile-tab active">
                    <div class="profile-section">
                        <h2>Personal Information</h2>
                        
                        <form class="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" value="{{ user.full_name }}" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" value="{{ user.email }}" class="form-input" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" value="{{ user.phone or '' }}" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth</label>
                                    <input type="date" value="{{ user.date_of_birth or '' }}" class="form-input">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Anniversary Date</label>
                                <input type="date" value="{{ user.date_of_anniversary or '' }}" class="form-input">
                            </div>

                            <button type="submit" class="btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>

                <!-- Addresses -->
                <div id="addresses" class="profile-tab">
                    <div class="profile-section">
                        <div class="section-header">
                            <h2>My Addresses</h2>
                            <button onclick="showAddressModal()" class="btn-primary">+ Add New Address</button>
                        </div>

                        <div class="addresses-grid">
                            {% for address in addresses %}
                            <div class="address-card {% if address.is_default %}default-address{% endif %}">
                                {% if address.is_default %}
                                <span class="default-badge">Default</span>
                                {% endif %}
                                
                                <h4>Delivery Address</h4>
                                <p>{{ address.address_line1 }}</p>
                                {% if address.address_line2 %}
                                <p>{{ address.address_line2 }}</p>
                                {% endif %}
                                <p>{{ address.city }}, {{ address.state }} - {{ address.pincode }}</p>

                                <div class="address-actions">
                                    <button class="btn-link">Edit</button>
                                    <button class="btn-link text-danger">Delete</button>
                                </div>
                            </div>
                            {% endfor %}

                            {% if not addresses %}
                            <p class="empty-message">No addresses added yet</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Orders -->
                <div id="orders" class="profile-tab">
                    <div class="profile-section">
                        <h2>My Orders</h2>

                        <div class="orders-list">
                            {% for order in orders %}
                            <div class="order-card">
                                <div class="order-header">
                                    <div>
                                        <h3>Order #{{ order.order_number }}</h3>
                                        <p class="order-date">{{ order.created_at[:10] }}</p>
                                    </div>
                                    <div class="order-status status-{{ order.status }}">
                                        {{ order.status | capitalize }}
                                    </div>
                                </div>

                                <div class="order-items">
                                    {% for item in order['items'] %}
                                    <div class="order-item">
                                        <span>{{ item.product_name }} x {{ item.quantity }}</span>
                                        <span>₹{{ item.subtotal }}</span>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="order-footer">
                                    <div class="order-total">
                                        <strong>Total: ₹{{ order.total_amount }}</strong>
                                    </div>
                                    <div class="order-actions">
                                        {% if order.status == 'pending' %}
                                        <button class="btn-outline" onclick="cancelOrder('{{ order.id }}')">Cancel Order</button>
                                        {% endif %}
                                        <a href="{{ url_for('order_details', order_id=order.id) }}" class="btn-primary" style="text-decoration: none;">View Details</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            {% if not orders %}
                            <div class="empty-orders">
                                <p>You haven't placed any orders yet</p>
                                <a href="{{ url_for('home') }}" class="btn-primary">Start Shopping</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all nav items
    document.querySelectorAll('.profile-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    
    // Highlight active nav item
    const navItem = document.querySelector(`a[href="#${tabId}"]`);
    if (navItem) {
        navItem.classList.add('active');
    }
}

function showAddressModal() {
    alert('Address modal will be implemented');
}

async function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/orders/${orderId}/cancel`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Order cancelled successfully');
            location.reload();
        } else {
            alert(data.detail || 'Failed to cancel order');
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        alert('Failed to cancel order. Please try again.');
    }
}

// Check URL hash on page load to show correct tab
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1); // Remove #
    if (hash && document.getElementById(hash)) {
        showTab(hash);
    }
});
</script>
{% endblock %}
